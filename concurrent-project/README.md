
# Java内存模型

## 线程与JVM

### 基本概念
程序: 代码，完成某一件任务的代码序列(静态的概念)  
进程: 程序在某个数据上的一次运行(动态的概念)  
线程: 一个进程可能包含一个或多个线程(占有资源的独立单元)

## 内存区域与内存模型的区别

### JVM内存区域
- 方法区(信息共享): 类信息、常量、静态变量、JIT(即时编译)
- 堆(信息共享):实例对象
- 栈(非信息共享): Java方法在运行的内存模型
- 程序计数器(非信息共享): 执行下一条指令的地址
- 本地方法栈(信息共享):虚拟机使用到的native方法服务
 
### Java内存模型(Java Memory Model)
- 主内存: 共享信息
- 工作内存: 私有信息 基本数据类型直接分配到工作内存。引用的地址存放在工作内存,引用对象存放在堆中。
- 工作方式: Java内存模型规定了所有的变量都存储在主内存中，每条线程都有自己的工作内存，线程的工作内存中保存了该线程中用到的变量的主内存副本拷贝，线程对变量的所有操作都必须在工作内存中进行，而不能直接读取主内存。不同的线程之间也无法直接访问对方工作内存中的变量，线程间变量的传递均需要自己的工作内存和主内存之间进行数据同步。

## 硬件内存架构与内存模型
a) CPU缓存的一致性问题: 并发处理的不同步  
b) 解决方案:  
i.总线加锁  降低CPU的吞吐量  
ii.缓存上的一致性协议（MESI）  
当CPU在CACHE中操作数据时，如果该数据是共享变量，数据在CACHE读到寄存器中，进行新修改，并更新内存数据
CaCHE  LINE置无效，其他的CPU就从内存中读数据

## 并发编程的三个重要特性
- 原子性：不可分割  x=1
- 可见性：线程只能操作自己工作空间中的数据
- 有序性：程序中的顺序不一定就是执行的顺序
  - 编译重排序
  - 指令重排序 提高效率